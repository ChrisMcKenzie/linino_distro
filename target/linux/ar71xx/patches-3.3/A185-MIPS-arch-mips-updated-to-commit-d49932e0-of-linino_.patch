From c549c1d758a1a9b38f5561384e2153f55f86ea13 Mon Sep 17 00:00:00 2001
From: Aurelio Colosimo <aurelio@aureliocolosimo.it>
Date: Mon, 1 Dec 2014 11:11:54 +0100
Subject: [PATCH 185/188] MIPS arch/mips updated to commit d49932e0 of
 linino_distro

Signed-off-by: Aurelio Colosimo <aurelio@aureliocolosimo.it>
---
 arch/mips/ath79/mach-linino.c                  |   64 ++++++++++++++++++++----
 arch/mips/ath79/mach-tl-wdr4300.c              |   10 ++++
 arch/mips/include/asm/mach-ath79/mach-linino.h |   19 ++++---
 3 files changed, 75 insertions(+), 18 deletions(-)

diff --git a/arch/mips/ath79/mach-linino.c b/arch/mips/ath79/mach-linino.c
index df95ceb..2305807 100644
--- a/arch/mips/ath79/mach-linino.c
+++ b/arch/mips/ath79/mach-linino.c
@@ -38,6 +38,20 @@ static struct gpio_led ds_leds_gpio[] __initdata = {
 		.gpio = DS_GPIO_LED_WLAN,
 		.active_low = 0,
 	},
+#if defined(LININO_CHIWAWA)
+	{
+		.name = "ds:green:lan0",
+		.gpio = DS_GPIO_LED2,
+		.active_low = 0,
+		.default_trigger = "netdev"
+	},
+	{
+		.name = "ds:green:lan1",
+		.gpio = DS_GPIO_LED4,
+		.active_low = 0,
+		.default_trigger = "netdev"
+	},
+#endif
 };
 
 /* * * * * * * * * * * * * * * * * BUTTONS * * * * * * * * * * * * * * * * * */
@@ -101,10 +115,15 @@ static struct spi_board_info linino_spi_info[] = {
 static void ds_register_spi(void) {
 	pr_info("mach-linino: enabling GPIO SPI Controller");
 
+ 	#if defined(LININO_FREEDOG)
+        /* Enable level shifter on SPI signals */
+        gpio_set_value(DS_GPIO_OE, 1);
+	#else	
 	/* Enable level shifter on SPI signals */
 	gpio_set_value(DS_GPIO_OE, 1);
 	/* Enable level shifter on AVR interrupt */
 	gpio_set_value(DS_GPIO_OE2, 1);
+	#endif
 	/* Register SPI devices */
 	spi_register_board_info(linino_spi_info, ARRAY_SIZE(linino_spi_info));
 	/* Register GPIO SPI controller */
@@ -130,10 +149,10 @@ static void __init ds_common_setup(void)
 	}
 
 	mac[3] |= 0x08;
-	ath79_init_mac(ath79_eth0_data.mac_addr, mac, 0);
+	ath79_init_mac(ath79_eth1_data.mac_addr, mac, 0);
 
 	mac[3] &= 0xF7;
-	ath79_init_mac(ath79_eth1_data.mac_addr, mac, 0);
+	ath79_init_mac(ath79_eth0_data.mac_addr, mac, 0);
 
 	ath79_register_mdio(0, 0x0);
 
@@ -159,13 +178,32 @@ static void __init ds_setup_level_shifter_oe(void)
 	if (err)
 		pr_err("mach-linino: error setting GPIO OE\n");
 
-	/* enable OE2 of level shifter */
-	pr_info("Setting GPIO OE2 %d\n", DS_GPIO_OE2);
-	err= gpio_request_one(DS_GPIO_OE2,
-			      GPIOF_OUT_INIT_LOW | GPIOF_EXPORT_DIR_FIXED,
-			      "OE-2");
-	if (err)
-		pr_err("mach-linino: error setting GPIO OE2\n");
+	#if defined(LININO_FREEDOG)
+        /* enable SWD_OE to be low as default */
+        pr_info("Setting GPIO SWD OE %d\n", DS_GPIO_SWD_OE);
+        err= gpio_request_one(DS_GPIO_SWD_OE,
+                              GPIOF_OUT_INIT_LOW | GPIOF_EXPORT_DIR_FIXED,
+                              "SWD_OE");
+        if (err)
+                pr_err("mach-linino: error setting GPIO SWD_OE\n");
+
+        /* enable SWD_EN to be low as default */
+        pr_info("Setting GPIO SWD EN %d\n", DS_GPIO_SWD_EN);
+        err= gpio_request_one(DS_GPIO_SWD_EN,
+                              GPIOF_OUT_INIT_LOW | GPIOF_EXPORT_DIR_FIXED,
+                              "SWD_EN");
+        if (err)
+                pr_err("mach-linino: error setting GPIO SWD_EN\n");
+	#else
+
+        /* enable OE2 of level shifter */
+        pr_info("Setting GPIO OE2 %d\n", DS_GPIO_OE2);
+        err= gpio_request_one(DS_GPIO_OE2,
+                              GPIOF_OUT_INIT_LOW | GPIOF_EXPORT_DIR_FIXED,
+                              "OE-2");
+        if (err)
+                pr_err("mach-linino: error setting GPIO OE2\n");
+	#endif
 }
 
 
@@ -178,7 +216,7 @@ static void ds_setup_uart_enable(void)
 
 	pr_info("Setting GPIO UART-ENA %d\n", DS_GPIO_UART_ENA);
 	err = gpio_request_one(DS_GPIO_UART_ENA,
-			       GPIOF_OUT_INIT_LOW | GPIOF_EXPORT_DIR_FIXED,
+			       DS_GPIO_UART_POL | GPIOF_EXPORT_DIR_FIXED,
 			       "UART-ENA");
 	if (err)
 		pr_err("mach-linino: error setting GPIO Uart Enable\n");
@@ -196,6 +234,12 @@ static void __init ds_setup(void)
 			ARRAY_SIZE(ds_gpio_keys), ds_gpio_keys);
 	ath79_register_usb();
 
+	// use the swtich_led directly form sysfs
+	ath79_gpio_function_disable(AR933X_GPIO_FUNC_ETH_SWITCH_LED0_EN |
+	                            AR933X_GPIO_FUNC_ETH_SWITCH_LED1_EN |
+	                            AR933X_GPIO_FUNC_ETH_SWITCH_LED2_EN |
+	                            AR933X_GPIO_FUNC_ETH_SWITCH_LED3_EN);
+
 	/*
 	 * Disable the Function for some pins to have GPIO functionality active
 	 * GPIO6-7-8 and GPIO11
diff --git a/arch/mips/ath79/mach-tl-wdr4300.c b/arch/mips/ath79/mach-tl-wdr4300.c
index 7be2955..ea4b1c8 100644
--- a/arch/mips/ath79/mach-tl-wdr4300.c
+++ b/arch/mips/ath79/mach-tl-wdr4300.c
@@ -37,6 +37,9 @@
 #define WDR4300_GPIO_BTN_WPS		16
 #define WDR4300_GPIO_BTN_RFKILL		17
 
+#define WDR4300_GPIO_EXTERNAL_LNA0	18
+#define WDR4300_GPIO_EXTERNAL_LNA1	19
+
 #define WDR4300_GPIO_USB1_POWER		22
 #define WDR4300_GPIO_USB2_POWER		21
 
@@ -152,6 +155,13 @@ static void __init wdr4300_setup(void)
 					ARRAY_SIZE(wdr4300_gpio_keys),
 					wdr4300_gpio_keys);
 
+	gpio_request_one(WDR4300_GPIO_EXTERNAL_LNA0,
+			 GPIOF_OUT_INIT_HIGH | GPIOF_EXPORT_DIR_FIXED,
+			 "external LNA0");
+	gpio_request_one(WDR4300_GPIO_EXTERNAL_LNA1,
+			 GPIOF_OUT_INIT_HIGH | GPIOF_EXPORT_DIR_FIXED,
+			 "external LNA1");
+
 	ath79_init_mac(tmpmac, mac, -1);
 	ath79_register_wmac(art + WDR4300_WMAC_CALDATA_OFFSET, tmpmac);
 
diff --git a/arch/mips/include/asm/mach-ath79/mach-linino.h b/arch/mips/include/asm/mach-ath79/mach-linino.h
index 7588786..e0d0528 100644
--- a/arch/mips/include/asm/mach-ath79/mach-linino.h
+++ b/arch/mips/include/asm/mach-ath79/mach-linino.h
@@ -28,6 +28,11 @@
 #define DS_GPIO_LED_WLAN		0
 #define DS_GPIO_LED_USB			1
 
+#define DS_GPIO_LED2			13
+#define DS_GPIO_LED3			14
+#define DS_GPIO_LED4			15
+#define DS_GPIO_LED5			16
+
 #define DS_GPIO_OE			21
 #define DS_GPIO_MCU_RESET		18
 
@@ -36,9 +41,12 @@
 
 /* Configure level shifter enable GPIO */
 #if defined(LININO_FREEDOG)
-	#define DS_GPIO_OE2		11
+	#define DS_GPIO_SWD_EN		12
+	#define DS_GPIO_SWD_OE		11
+	#define DS_GPIO_UART_POL 	GPIOF_OUT_INIT_HIGH
 #else	/* YUN */
 	#define DS_GPIO_OE2		22
+	#define DS_GPIO_UART_POL        GPIOF_OUT_INIT_LOW
 #endif
 
 #define DS_KEYS_POLL_INTERVAL		20	/* msecs */
@@ -54,7 +62,7 @@
 
 #if defined(LININO_FREEDOG)
 	#define	LININO_GPIO_SPI_SCK	7
-	#define	LININO_GPIO_SPI_MISO	6
+	#define	LININO_GPIO_SPI_MISO	8
 #else	/* YUN */
 	#define	LININO_GPIO_SPI_SCK	11
 	#define	LININO_GPIO_SPI_MISO	8
@@ -64,11 +72,6 @@
 #define	LININO_N_SPI_CHIP_SELECT	1
 
 #define LININO_GPIO_SPI_CS0	26
-
-#if defined(LININO_FREEDOG)
-	#define LININO_GPIO_SPI_INTERRUPT		23
-#elif defined(CONFIG_ATH79_MACH_LININO_YUN)
-	#define LININO_GPIO_SPI_INTERRUPT		19
-#endif
+#define LININO_GPIO_SPI_INTERRUPT	19
 
 #endif /* MACH_LININO_H_ */
-- 
1.7.9.5

